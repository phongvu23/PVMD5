function applyReplacement() {
  const replacement1 = parseInt(document.getElementById('replacement1').value);
  const replacement2 = parseInt(document.getElementById('replacement2').value);
  const replacement3 = parseInt(document.getElementById('replacement3').value);
  
  if (isNaN(replacement1) || isNaN(replacement2) || isNaN(replacement3)) {
    alert("Vui lòng nhập cả 3 số hợp lệ.");
    return;
  }
  
  const resultDiv = document.getElementById('result');
  const originalResult = resultDiv.innerText.split('✅ Kết quả: ')[1];
  const [mappedPartsStr, randomStr] = originalResult.split('|');
  const mappedParts = mappedPartsStr.split('-');

  // Lấy mapping hiện tại
  const currentMapping = getMapping();
  
  // Tạo mapping mới dựa trên giá trị thay thế
  const newMapping = {...currentMapping};
  
  // Tìm và cập nhật các key tương ứng với giá trị cũ
  for (let i = 1; i <= 6; i++) {
    if (newMapping[i] === mappedParts[0]) newMapping[i] = replacement1.toString();
    if (newMapping[i] === mappedParts[1]) newMapping[i] = replacement2.toString();
    if (newMapping[i] === mappedParts[2]) newMapping[i] = replacement3.toString();
  }
  
  // Lưu mapping mới
  localStorage.setItem('customMapping', JSON.stringify(newMapping));
  
  // Cập nhật UI với mapping mới
  loadCurrentMapping();
  
  // Ẩn ô nhập sau khi áp dụng
  document.getElementById('replaceMapping').classList.add('hidden');
  
  // Hiển thị thông báo thành công
  resultDiv.innerText = '✅ Đã cập nhật mapping thành công!';
  
  // Reset các ô nhập
  document.getElementById('replacement1').value = '';
  document.getElementById('replacement2').value = '';
  document.getElementById('replacement3').value = '';
}

function generateRandomResult(md5Hash) {
  if (typeof md5Hash !== 'string' || md5Hash.length !== 32 || !/^[0-9a-f]{32}$/i.test(md5Hash)) {
    throw new Error("Mã MD5 không hợp lệ. Vui lòng nhập chuỗi MD5 gồm 32 ký tự hexa.");
  }

  // Tạo số ngẫu nhiên từ MD5 - luôn giống nhau với cùng 1 MD5
  let number = BigInt('0x' + md5Hash); 
  let num1 = Number((number % 6n) + 1n);
  number = (number * 3n + 7n) % 10000000000n;
  let num2 = Number((number % 6n) + 1n);
  number = ((number - 5n) * 2n) % 10000000000n;
  let num3 = Number((number % 6n) + 1n);

  // Áp dụng mapping hiện tại
  const mapping = getMapping();
  const mapped = [mapping[num1], mapping[num2], mapping[num3]];

  // Tạo chuỗi ngẫu nhiên (không ảnh hưởng bởi mapping)
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:',.<>/?";
  let randomStr = "";
  for (let i = 0; i < 30; i++) {
    randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
  }

  return { 
    result: `${mapped.join('-')}|${randomStr}`, 
    original: mapped,
    originalNumbers: [num1, num2, num3] // Lưu các số gốc trước khi mapping
  };
}
