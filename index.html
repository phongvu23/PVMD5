<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>MD5 Dự đoán</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    #results li.red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2 id="welcome">Chào mừng!</h2>

  <div id="login-section">
    <input type="text" id="username" placeholder="Tài khoản"><br>
    <input type="password" id="password" placeholder="Mật khẩu"><br>
    <button onclick="handleLogin()">Đăng nhập</button>
    <button onclick="handleRegister()">Đăng ký</button>
    <p id="login-error" style="color:red;"></p>
  </div>

  <div id="admin-section" class="hidden">
    <h3>Admin: Cộng lượt quay</h3>
    <input type="number" id="add-spins" placeholder="Số lượt muốn cộng">
    <button onclick="addSpinsToAll()">Cộng</button>
  </div>

  <div id="app-section" class="hidden">
    <p id="spin-count"></p>
    <input type="text" id="md5-input" placeholder="Nhập mã MD5"><br>
    <button onclick="generateResult()">Tạo kết quả</button>
    <ul id="results"></ul>
  </div>

  <script>
    const ADMIN_USER = "phongvu";
    const ADMIN_PASS = "123";
    const MAX_RESULTS = 10;

    let currentUser = null;

    function loadUsers() {
      return JSON.parse(localStorage.getItem("users") || "{}");
    }

    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    function getUserData() {
      return JSON.parse(localStorage.getItem("userData") || "{}");
    }

    function saveUserData(data) {
      localStorage.setItem("userData", JSON.stringify(data));
    }

    function handleLogin() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const users = loadUsers();

      if ((username === ADMIN_USER && password === ADMIN_PASS) || users[username] === password) {
        currentUser = username;
        localStorage.setItem("loggedInUser", currentUser);
        showApp();
      } else {
        document.getElementById("login-error").innerText = "Sai tài khoản hoặc mật khẩu.";
      }
    }

    function handleRegister() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const users = loadUsers();
      const deviceId = localStorage.getItem("registeredOnce");

      if (!username || !password) {
        document.getElementById("login-error").innerText = "Không được để trống.";
        return;
      }

      if (deviceId) {
        document.getElementById("login-error").innerText = "Thiết bị này đã đăng ký tài khoản.";
        return;
      }

      if (users[username]) {
        document.getElementById("login-error").innerText = "Tài khoản đã tồn tại.";
        return;
      }

      users[username] = password;
      saveUsers(users);
      localStorage.setItem("registeredOnce", "yes");
      document.getElementById("login-error").innerText = "Đăng ký thành công. Vui lòng đăng nhập.";
    }

    function showApp() {
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("app-section").classList.remove("hidden");
      document.getElementById("welcome").innerText = "Xin chào, " + currentUser;

      if (currentUser === ADMIN_USER) {
        document.getElementById("admin-section").classList.remove("hidden");
      }

      initUserData();
      updateSpinText();
      loadResults();
    }

    function initUserData() {
      const data = getUserData();
      if (!data[currentUser]) {
        data[currentUser] = { spins: 1, results: [] };
        saveUserData(data);
      }
    }

    function updateSpinText() {
      const data = getUserData();
      const spins = data[currentUser]?.spins ?? 0;
      document.getElementById("spin-count").innerText = "Số lượt còn lại: " + spins;
    }

    function addSpinsToAll() {
      const amount = parseInt(document.getElementById("add-spins").value);
      if (isNaN(amount) || amount <= 0) return alert("Nhập số lượt hợp lệ");

      const data = getUserData();
      for (let user in data) {
        data[user].spins = (data[user].spins || 0) + amount;
      }
      saveUserData(data);
      alert("Đã cộng " + amount + " lượt quay cho tất cả!");
      updateSpinText();
    }

    function generateResult() {
      const md5 = document.getElementById("md5-input").value.trim().toLowerCase();
      if (!/^[a-f0-9]{32}$/.test(md5)) {
        alert("Mã MD5 không hợp lệ.");
        return;
      }

      const data = getUserData();
      const user = data[currentUser];

      if (currentUser !== ADMIN_USER && user.spins <= 0) {
        alert("Bạn đã hết lượt quay.");
        return;
      }

      const result = createResultFromMD5(md5);
      user.results.unshift(result);
      if (user.results.length > MAX_RESULTS) user.results.pop();

      if (currentUser !== ADMIN_USER) user.spins--;

      saveUserData(data);
      loadResults();
      updateSpinText();
      document.getElementById("md5-input").value = ""; // Xóa input
    }

    function createResultFromMD5(md5_hash) {
      const mapping = { 1: "3", 2: "2", 3: "1", 4: "5", 5: "6", 6: "4" };
      let number = parseInt(md5_hash, 16);

      const nums = [];
      for (let i = 0; i < 3; i++) {
        number = (number * 3 + 7 + i * 2) % (10 ** 10);
        nums.push(mapping[(number % 6) + 1]);
      }

      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
      let randomStr = "";
      for (let i = 0; i < 30; i++) {
        randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
      }

      return `${nums.join("-")}|${randomStr}`;
    }

    function loadResults() {
      const data = getUserData();
      const results = data[currentUser]?.results || [];
      const ul = document.getElementById("results");
      ul.innerHTML = "";

      results.forEach((res, index) => {
        const li = document.createElement("li");
        li.innerText = `${index + 1}. ${res}`;
        if (index === 0) li.classList.add("red");
        ul.appendChild(li);
      });
    }

    window.onload = () => {
      const user = localStorage.getItem("loggedInUser");
      if (user) {
        currentUser = user;
        showApp();
      }
    };
  </script>
</body>
</html>
