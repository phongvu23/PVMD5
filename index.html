function applyReplacement() {
  const replacement1 = document.getElementById('replacement1').value;
  const replacement2 = document.getElementById('replacement2').value;
  const replacement3 = document.getElementById('replacement3').value;
  
  // Kiểm tra hợp lệ
  if (!replacement1 || !replacement2 || !replacement3) {
    alert("Vui lòng nhập đầy đủ 3 số");
    return;
  }

  const num1 = parseInt(replacement1);
  const num2 = parseInt(replacement2);
  const num3 = parseInt(replacement3);
  
  if (isNaN(num1) || isNaN(num2) || isNaN(num3)) {
    alert("Vui lòng nhập số hợp lệ");
    return;
  }

  const resultDiv = document.getElementById('result');
  const resultText = resultDiv.innerText.replace('✅ Kết quả: ', '');
  const [mappedPartsStr, randomStr] = resultText.split('|');
  const oldValues = mappedPartsStr.split('-');

  // Lấy mapping hiện tại
  const currentMapping = getMapping();
  const newMapping = {...currentMapping};

  // Tìm và cập nhật mapping
  let updated = false;
  for (const key in newMapping) {
    if (newMapping[key] === oldValues[0]) {
      newMapping[key] = num1.toString();
      updated = true;
    }
    if (newMapping[key] === oldValues[1]) {
      newMapping[key] = num2.toString();
      updated = true;
    }
    if (newMapping[key] === oldValues[2]) {
      newMapping[key] = num3.toString();
      updated = true;
    }
  }

  if (!updated) {
    alert("Không tìm thấy giá trị cần thay thế trong mapping");
    return;
  }

  // Lưu mapping mới
  localStorage.setItem('customMapping', JSON.stringify(newMapping));
  
  // Cập nhật UI
  loadCurrentMapping();
  document.getElementById('replaceMapping').classList.add('hidden');
  resultDiv.innerText = '✅ Đã cập nhật mapping thành công!';
  
  // Reset các ô nhập
  document.getElementById('replacement1').value = '';
  document.getElementById('replacement2').value = '';
  document.getElementById('replacement3').value = '';
}

function generateRandomResult(md5Hash) {
  if (typeof md5Hash !== 'string' || md5Hash.length !== 32 || !/^[0-9a-f]{32}$/i.test(md5Hash)) {
    throw new Error("Mã MD5 không hợp lệ. Vui lòng nhập chuỗi MD5 gồm 32 ký tự hexa.");
  }

  // Tạo số ngẫu nhiên từ MD5 - luôn giống nhau với cùng 1 MD5
  let number = BigInt('0x' + md5Hash); 
  let num1 = Number((number % 6n) + 1n);
  number = (number * 3n + 7n) % 10000000000n;
  let num2 = Number((number % 6n) + 1n);
  number = ((number - 5n) * 2n) % 10000000000n;
  let num3 = Number((number % 6n) + 1n);

  // Áp dụng mapping hiện tại
  const mapping = getMapping();
  const mapped = [mapping[num1], mapping[num2], mapping[num3]];

  // Tạo chuỗi ngẫu nhiên (không ảnh hưởng bởi mapping)
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:',.<>/?";
  let randomStr = "";
  for (let i = 0; i < 30; i++) {
    randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
  }

  return { 
    result: `${mapped.join('-')}|${randomStr}`, 
    original: mapped,
    originalNumbers: [num1, num2, num3] // Lưu các số gốc trước khi mapping
  };
}
